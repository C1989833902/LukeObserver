<!DOCTYPE html>
<html lang="{{ site.lang | default: " en-US" }}">

<head>
    {% if site.google_analytics %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', '{{ site.google_analytics }}');
    </script>
    {% endif %}
    <meta charset="UTF-8">

    {% seo %}
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style"
        type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}">

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/moment-timezone@0.5.33/builds/moment-timezone-with-data-10-year-range.min.js"></script>
</head>

<body>
    <!-- <a id="skip-to-content" href="#content">Skip to the content.</a> -->

    <header class="page-header" role="banner">
        <h1 class="project-name">{{ page.title | default: site.title | default: site.github.repository_name }}</h1>
        <h2 class="project-tagline">{{ page.description | default: site.description | default:
            site.github.project_tagline }}</h2>
        {% if site.github.is_project_page %}
        <a href="{{ site.github.repository_url }}" class="btn">View on GitHub</a>
        {% endif %}
        {% if site.show_downloads %}
        <a href="{{ site.github.zip_url }}" class="btn">Download .zip</a>
        <a href="{{ site.github.tar_url }}" class="btn">Download .tar.gz</a>
        {% endif %}
    </header>

    <main id="content" class="main-content" role="main">
        {{ content }}

        <footer class="site-footer">
            {% if site.github.is_project_page %}
            <span class="site-footer-owner"><a href="{{ site.github.repository_url }}">{{ site.github.repository_name
                    }}</a> is maintained by <a href="{{ site.github.owner_url }}">{{ site.github.owner_name
                    }}</a>.</span>
            {% endif %}
            <span class="site-footer-credits">This page was generated by 呆毛充能的 <a href="https://pages.github.com">GitHub
                    Pages</a>.</span>
        </footer>
    </main>

    <script>
        var curr_play;
        var roundplay_seq;
        var max_seq_num;

        function load_data() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var parsed = JSON.parse(this.responseText);
                    curr_play = parsed.curr_play;
                    roundplay_seq = parsed.roundplay_seq;
                    var seq_nums = Object.keys(roundplay_seq).map(function (x) {
                        return parseInt(x, 10);
                    });
                    max_seq_num = Math.max(...seq_nums);
                }
            }
            xhttp.open("GET", "assets/rplist/21602686/roundplay_seq.json", true);
            xhttp.send();
        };

        load_data();

        const fp = flatpickr("#dtpicker", {
            inline: true,
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            defaultHour: 19,
            defaultMinute: 0,
            onChange: function (selectedDates, dateStr, instance) {
                selected_date = moment.tz(dateStr, "Asia/Shanghai");
                predict_roundplay(selected_date);
            }
        });

        function predict_roundplay(selected_date) {
            var curr_time_isostr = new Date(Date.parse(curr_play.time)).toISOString();
            var curr_play_time = moment(curr_time_isostr);
            var after_time = Math.round(moment.duration(selected_date.diff(curr_play_time)).as('seconds'));

            var rptime_str = "";
            var rplink_str = "";
            var rplink_url = "";

            var sequence = curr_play.sequence;
            var play_time = curr_play.play_time;

            var to_play_ts;
            if (after_time >= 0) {
                var sum_play_time = after_time + play_time;
                var seq_i = sequence;
                var summed_play_time = 0;

                while (true) {
                    while (!(seq_i in roundplay_seq)) {
                        seq_i += 1;
                        if (seq_i > max_seq_num) {
                            seq_i = 1;
                        }
                    }
                    summed_play_time += roundplay_seq[seq_i.toString()]["duration"];
                    if (summed_play_time > sum_play_time) {
                        break;
                    }
                    seq_i += 1;
                    if (seq_i > max_seq_num) {
                        seq_i = 1;
                    }
                }

                var to_play = roundplay_seq[seq_i.toString()];
                to_play_ts = to_play.duration - (summed_play_time - sum_play_time);
            } else {
                after_time = -after_time;
                var sum_play_time = after_time + roundplay_seq[sequence].duration - play_time;
                var seq_i = sequence;
                var summed_play_time = 0;

                while (true) {
                    while (!(seq_i in roundplay_seq)) {
                        seq_i -= 1;
                        if (seq_i < 1) {
                            seq_i = max_seq_num;
                        }
                    }
                    summed_play_time += roundplay_seq[seq_i.toString()]["duration"];
                    // console.log(seq_i, roundplay_seq[seq_i.toString()]['duration'], summed_play_time, sum_play_time);
                    if (summed_play_time > sum_play_time) {
                        break;
                    }
                    seq_i -= 1;
                    if (seq_i < 1) {
                        seq_i = max_seq_num;
                    }
                }
                // console.log(" ");

                var to_play = roundplay_seq[seq_i.toString()];
                to_play_ts = summed_play_time - sum_play_time;
            }

            var to_play_ts_m = Math.floor(to_play_ts / 60);
            var to_play_ts_s = to_play_ts % 60;
            rptime_str = selected_date.format();
            rplink_str = to_play_ts_m.toString() + ":" + to_play_ts_s.toString().padStart(2, "0") + "    " + to_play.title;
            rplink_url = to_play.video_url + "&t=" + to_play_ts.toString();
            document.getElementById("rptime").innerHTML = rptime_str;
            document.getElementById("rplink").innerHTML = "<a href=\"" + rplink_url + "\">" + rplink_str + "</a>";
        }

    </script>
</body>

</html>